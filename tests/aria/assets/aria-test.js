// Inline behavior JS (also written to assets/aria-test.js)
(function(){
  const role = "generic";
  const root = document.getElementById('widget-root');
  const ariaVariant = document.getElementById('aria-role-target');
  const shadowToggle = document.getElementById('toggle-shadow');
  const shadowHostContainer = document.getElementById('shadow-host-container');
  let shadowEnabled = false;

  function byAttrInputs(){ return Array.from(document.querySelectorAll('[data-attr]')); }
  function targetElement(){ return root || ariaVariant; }
  function applyAttr(el, name, value){ if(!el) return; if(!value && value !== '0'){ el.removeAttribute(name); return; } el.setAttribute(name, value); }
  function handleAttrChange(e){ const input=e.target; if(!input.matches('[data-attr]')) return; const attr=input.getAttribute('data-attr'); const val=input.value.trim(); [targetElement(), ariaVariant].filter(Boolean).forEach(el=>applyAttr(el, attr, val)); }
  document.addEventListener('input', handleAttrChange);

  function toggleAriaPressed(el){ if(!el) return; const cur=el.getAttribute('aria-pressed')==='true'; el.setAttribute('aria-pressed', String(!cur)); }
  function toggleAriaChecked(el){ if(!el) return; const cur=el.getAttribute('aria-checked'); let next=(cur==='true')?'false':'true'; if(cur==='mixed') next='true'; el.setAttribute('aria-checked', next); }

  // Enhanced role-specific behaviors (Step 3)
  switch(role){
    case 'button':
      if(ariaVariant) ariaVariant.addEventListener('keydown', e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); toggleAriaPressed(ariaVariant); }});
      ariaVariant && ariaVariant.addEventListener('click', ()=>toggleAriaPressed(ariaVariant));
      break;
    case 'checkbox':
    case 'switch':
      ariaVariant && ariaVariant.addEventListener('keydown', e=>{ if(e.key===' '){ e.preventDefault(); toggleAriaChecked(ariaVariant);} });
      ariaVariant && ariaVariant.addEventListener('click', ()=>toggleAriaChecked(ariaVariant));
      break;
    case 'radio':
    case 'radiogroup': { const group=document.querySelector('[role=radiogroup]'); if(group){ group.addEventListener('keydown', e=>{ if(['ArrowLeft','ArrowUp','ArrowRight','ArrowDown'].includes(e.key)){ e.preventDefault(); const radios=[...group.querySelectorAll('[role=radio]')]; const current=radios.find(r=>r.getAttribute('aria-checked')==='true'); let i=radios.indexOf(current); i=(e.key==='ArrowLeft'||e.key==='ArrowUp')? (i-1+radios.length)%radios.length : (i+1)%radios.length; radios.forEach(r=>{ r.setAttribute('aria-checked','false'); r.tabIndex=-1; }); radios[i].setAttribute('aria-checked','true'); radios[i].tabIndex=0; radios[i].focus(); } }); group.addEventListener('click', e=>{ const r=e.target.closest('[role=radio]'); if(!r)return; const radios=group.querySelectorAll('[role=radio]'); radios.forEach(n=>{ n.setAttribute('aria-checked','false'); n.tabIndex=-1; }); r.setAttribute('aria-checked','true'); r.tabIndex=0; r.focus(); }); } break; }
    case 'slider': { const slider=ariaVariant; if(slider){ slider.addEventListener('keydown', e=>{ const keyMap={ArrowLeft:-10,ArrowDown:-10,ArrowRight:10,ArrowUp:10,Home:'min',End:'max'}; if(!(e.key in keyMap)) return; e.preventDefault(); let val=parseInt(slider.getAttribute('aria-valuenow'),10); const min=parseInt(slider.getAttribute('aria-valuemin'),10); const max=parseInt(slider.getAttribute('aria-valuemax'),10); const delta=keyMap[e.key]; if(delta==='min') val=min; else if(delta==='max') val=max; else val=Math.min(max, Math.max(min, val+delta)); slider.setAttribute('aria-valuenow', String(val)); const thumb=slider.querySelector('.slider-thumb'); if(thumb){ const pct=((val-min)/(max-min))*100; thumb.style.left=pct+'%'; } }); } break; }
    case 'progressbar': { const btn=document.getElementById('inc-progress'); const bar=ariaVariant; if(btn&&bar){ btn.addEventListener('click', ()=>{ const min=+bar.getAttribute('aria-valuemin'); const max=+bar.getAttribute('aria-valuemax'); let val=+bar.getAttribute('aria-valuenow'); val=Math.min(max,val+10); bar.setAttribute('aria-valuenow', String(val)); const inner=bar.querySelector('.bar'); if(inner){ const pct=((val-min)/(max-min))*100; inner.style.width=pct+'%'; } }); } break; }
    case 'spinbutton': { const spin=ariaVariant; if(spin){ spin.addEventListener('keydown', e=>{ if(['ArrowUp','ArrowDown','PageUp','PageDown','Home','End'].includes(e.key)){ e.preventDefault(); const min=+spin.getAttribute('aria-valuemin'); const max=+spin.getAttribute('aria-valuemax'); let val=+spin.getAttribute('aria-valuenow'); const step=(e.key==='PageUp'||e.key==='PageDown')?5:1; if(e.key==='ArrowUp'||e.key==='PageUp') val=Math.min(max,val+step); else if(e.key==='ArrowDown'||e.key==='PageDown') val=Math.max(min,val-step); else if(e.key==='Home') val=min; else if(e.key==='End') val=max; spin.setAttribute('aria-valuenow', String(val)); spin.textContent=val; } }); } break; }
    case 'combobox': { const input=document.getElementById('cb-input'); const list=document.getElementById('cb-list'); if(input&&list){ const options=[...list.querySelectorAll('[role=option]')]; function open(){ list.hidden=false; input.setAttribute('aria-expanded','true'); } function close(){ list.hidden=true; input.setAttribute('aria-expanded','false'); input.setAttribute('aria-activedescendant',''); } input.addEventListener('input', ()=>{ const term=input.value.toLowerCase(); options.forEach(o=>{ o.hidden=!o.textContent.toLowerCase().includes(term); }); open(); }); input.addEventListener('keydown', e=>{ const visible=options.filter(o=>!o.hidden); let idx=visible.findIndex(o=>o.id===input.getAttribute('aria-activedescendant')); if(e.key==='ArrowDown'){ e.preventDefault(); if(list.hidden) open(); idx=(idx+1)%visible.length; } else if(e.key==='ArrowUp'){ e.preventDefault(); idx=(idx-1+visible.length)%visible.length; } else if(e.key==='Enter'){ const active=visible[idx]; if(active){ options.forEach(o=>o.setAttribute('aria-selected','false')); active.setAttribute('aria-selected','true'); input.value=active.textContent; close(); } } else if(e.key==='Escape'){ close(); return; } else return; const active=visible[idx]; if(active){ input.setAttribute('aria-activedescendant', active.id); } }); list.addEventListener('click', e=>{ const opt=e.target.closest('[role=option]'); if(!opt) return; options.forEach(o=>o.setAttribute('aria-selected','false')); opt.setAttribute('aria-selected','true'); input.value=opt.textContent; close(); }); document.addEventListener('click', e=>{ if(!e.target.closest('.combo-wrapper')) close(); }); } break; }
    case 'listbox': { const lb=document.getElementById('widget-root'); if(lb){ let anchor=null; function opts(){ return [...lb.querySelectorAll('[role=option]')]; } function focusOpt(o){ opts().forEach(opt=>opt.tabIndex=-1); o.tabIndex=0; o.focus(); } function toggleSelect(o, additive){ if(!additive){ opts().forEach(opt=>opt.setAttribute('aria-selected','false')); } const cur=o.getAttribute('aria-selected')==='true'; o.setAttribute('aria-selected', additive ? String(!cur) : 'true'); if(!anchor || !additive) anchor=o; } function rangeSelect(to){ if(!anchor) anchor=to; const list=opts(); const a=list.indexOf(anchor); const b=list.indexOf(to); const [start,end]= a<b ? [a,b] : [b,a]; list.forEach((o,i)=>{ o.setAttribute('aria-selected', i>=start && i<=end ? 'true':'false'); }); } lb.addEventListener('click', e=>{ const opt=e.target.closest('[role=option]'); if(!opt) return; const multi=lb.getAttribute('aria-multiselectable')==='true'; toggleSelect(opt, multi && (e.metaKey||e.ctrlKey)); focusOpt(opt); }); lb.addEventListener('keydown', e=>{ const list=opts(); let current=document.activeElement.closest('[role=option]'); if(!current){ current=list[0]; focusOpt(current); return; } let idx=list.indexOf(current); if(e.key==='ArrowDown'){ e.preventDefault(); idx=Math.min(list.length-1, idx+1); focusOpt(list[idx]); if(e.shiftKey) rangeSelect(list[idx]); } else if(e.key==='ArrowUp'){ e.preventDefault(); idx=Math.max(0, idx-1); focusOpt(list[idx]); if(e.shiftKey) rangeSelect(list[idx]); } else if(e.key===' '){ e.preventDefault(); const multi=lb.getAttribute('aria-multiselectable')==='true'; if(e.shiftKey){ rangeSelect(current); } else toggleSelect(current, multi && (e.metaKey||e.ctrlKey)); } else if(e.key==='Home'){ e.preventDefault(); focusOpt(list[0]); if(e.shiftKey) rangeSelect(list[0]); } else if(e.key==='End'){ e.preventDefault(); focusOpt(list[list.length-1]); if(e.shiftKey) rangeSelect(list[list.length-1]); } }); } break; }
    case 'menu':
    case 'menubar': { const menubar=document.querySelector('[role=menubar]'); if(menubar){ function toggleSubmenu(trigger, openForce){ const submenu=trigger.querySelector('[role=menu]'); if(!submenu) return; const open=openForce!=null ? openForce : submenu.hidden; submenu.hidden=!open; trigger.setAttribute('aria-expanded', String(open)); if(!open) submenu.querySelectorAll('[role=menuitem],[role=menuitemcheckbox]').forEach(mi=>mi.tabIndex=-1); else submenu.querySelectorAll('[role=menuitem],[role=menuitemcheckbox]').forEach(mi=>mi.tabIndex=0); } function closeAll(){ menubar.querySelectorAll('.menu-trigger').forEach(t=>{ const sm=t.querySelector('[role=menu]'); if(sm){ sm.hidden=true; t.setAttribute('aria-expanded','false'); } }); } menubar.addEventListener('keydown', e=>{ const top=[...menubar.children]; const cur=e.target.closest('.menu-trigger'); let i=top.indexOf(cur); if(e.key==='ArrowRight'){ e.preventDefault(); i=(i+1)%top.length; top[i].focus(); } else if(e.key==='ArrowLeft'){ e.preventDefault(); i=(i-1+top.length)%top.length; top[i].focus(); } else if(['Enter',' ','ArrowDown'].includes(e.key)){ e.preventDefault(); toggleSubmenu(cur,true); const first=cur.querySelector('[role=menuitem]'); first && first.focus(); } else if(e.key==='Escape'){ e.preventDefault(); closeAll(); top[0].focus(); } }); menubar.addEventListener('keydown', e=>{ if(e.target.getAttribute('role')==='menuitem'){ const submenu=e.target.closest('[role=menu]'); if(!submenu) return; const items=[...submenu.querySelectorAll('[role=menuitem],[role=menuitemcheckbox]')]; let idx=items.indexOf(e.target); if(e.key==='ArrowDown'){ e.preventDefault(); idx=(idx+1)%items.length; items[idx].focus(); } else if(e.key==='ArrowUp'){ e.preventDefault(); idx=(idx-1+items.length)%items.length; items[idx].focus(); } else if(e.key==='Escape'){ e.preventDefault(); const parent=submenu.parentElement; toggleSubmenu(parent,false); parent.focus(); } else if(e.key==='ArrowRight'){ const nested=e.target.classList.contains('menu-trigger') ? e.target.querySelector('[role=menu]') : null; if(nested){ e.preventDefault(); toggleSubmenu(e.target,true); const first=nested.querySelector('[role=menuitem]'); first && first.focus(); } } else if(e.key==='ArrowLeft'){ const parentTrigger=submenu.parentElement.closest('.menu-trigger'); if(parentTrigger){ e.preventDefault(); toggleSubmenu(parentTrigger,false); parentTrigger.focus(); } } } }); menubar.addEventListener('click', e=>{ const trigger=e.target.closest('.menu-trigger'); if(trigger){ toggleSubmenu(trigger); } }); document.addEventListener('click', e=>{ if(!e.target.closest('[role=menubar]')) closeAll(); }); } break; }
    case 'tablist':
    case 'tab':
    case 'tabpanel': { const tablist=document.querySelector('[role=tablist]'); if(tablist){ function activate(tab){ const tabs=[...tablist.querySelectorAll('[role=tab]')]; tabs.forEach(t=>{ const sel=t===tab; t.setAttribute('aria-selected', String(sel)); t.tabIndex= sel?0:-1; const panel=document.getElementById(t.getAttribute('aria-controls')); if(panel) panel.hidden=!sel; }); tab.focus(); } tablist.addEventListener('click', e=>{ const t=e.target.closest('[role=tab]'); if(t) activate(t); }); tablist.addEventListener('keydown', e=>{ const tabs=[...tablist.querySelectorAll('[role=tab]')]; const current=document.activeElement.closest('[role=tab]'); let i=tabs.indexOf(current); if(['ArrowRight','ArrowDown'].includes(e.key)){ e.preventDefault(); i=(i+1)%tabs.length; activate(tabs[i]); } else if(['ArrowLeft','ArrowUp'].includes(e.key)){ e.preventDefault(); i=(i-1+tabs.length)%tabs.length; activate(tabs[i]); } else if(e.key==='Home'){ e.preventDefault(); activate(tabs[0]); } else if(e.key==='End'){ e.preventDefault(); activate(tabs[tabs.length-1]); } }); } break; }
    case 'tree':
    case 'treeitem': { const tree=document.querySelector('[role=tree]'); if(tree){ function toggleExpand(item, force){ const expanded=force!=null ? !force : item.getAttribute('aria-expanded')==='true'; const next=!expanded; item.setAttribute('aria-expanded', String(next)); const group=item.querySelector('[role=group]'); if(group) group.hidden=!next; } tree.addEventListener('keydown', e=>{ const items=[...tree.querySelectorAll('[role=treeitem]')]; const current=document.activeElement.closest('[role=treeitem]'); if(!current) return; let idx=items.indexOf(current); if(e.key==='ArrowDown'){ e.preventDefault(); idx=Math.min(items.length-1, idx+1); items[idx].focus(); } else if(e.key==='ArrowUp'){ e.preventDefault(); idx=Math.max(0, idx-1); items[idx].focus(); } else if(e.key==='ArrowRight'){ e.preventDefault(); if(current.getAttribute('aria-expanded')==='false'){ toggleExpand(current,true); } } else if(e.key==='ArrowLeft'){ e.preventDefault(); if(current.getAttribute('aria-expanded')==='true'){ toggleExpand(current,false); } } else if(e.key===' '){ e.preventDefault(); const sel=current.getAttribute('aria-selected')==='true'; current.setAttribute('aria-selected', String(!sel)); } }); tree.addEventListener('click', e=>{ const item=e.target.closest('[role=treeitem]'); if(!item) return; if(item.getAttribute('aria-expanded')) toggleExpand(item); const sel=item.getAttribute('aria-selected')==='true'; item.setAttribute('aria-selected', String(!sel)); }); } break; }
    case 'grid':
    case 'gridcell':
    case 'treegrid': { const grid=document.querySelector('[role=grid]'); if(grid){ let editingCell=null; grid.addEventListener('keydown', e=>{ const cells=[...grid.querySelectorAll('[role=gridcell]')]; const current=document.activeElement.closest('[role=gridcell]'); if(!current) return; const cols=grid.querySelectorAll('[role=row]')[1].querySelectorAll('[role=gridcell]').length; let idx=cells.indexOf(current); if(editingCell && e.key==='Escape'){ e.preventDefault(); const input=editingCell.querySelector('input'); if(input){ editingCell.textContent=input.getAttribute('data-orig'); editingCell.setAttribute('aria-selected','false'); editingCell.tabIndex=0; editingCell.focus(); editingCell=null; } return; } if(editingCell){ if(e.key==='Enter'){ e.preventDefault(); const input=editingCell.querySelector('input'); if(input){ editingCell.textContent=input.value; editingCell.setAttribute('aria-selected','false'); editingCell.tabIndex=0; editingCell.focus(); editingCell=null; } } return; } if(e.key==='ArrowRight'){ e.preventDefault(); idx=(idx+1)%cells.length; } else if(e.key==='ArrowLeft'){ e.preventDefault(); idx=(idx-1+cells.length)%cells.length; } else if(e.key==='ArrowDown'){ e.preventDefault(); idx=(idx+cols)%cells.length; } else if(e.key==='ArrowUp'){ e.preventDefault(); idx=(idx-cols+cells.length)%cells.length; } else if(e.key===' '){ e.preventDefault(); const sel=current.getAttribute('aria-selected')==='true'; current.setAttribute('aria-selected', String(!sel)); return; } else if(e.key==='Enter'){ e.preventDefault(); const val=current.textContent.trim(); current.setAttribute('data-orig', val); current.innerHTML='<input aria-label="Edit cell" data-orig="'+val.replace(/&/g,'&amp;').replace(/</g,'&lt;')+'" value="'+val.replace(/&/g,'&amp;').replace(/</g,'&lt;')+'" />'; const input=current.querySelector('input'); editingCell=current; input.focus(); input.select(); return; } else return; cells.forEach(c=>c.tabIndex=-1); const next=cells[idx]; next.tabIndex=0; next.focus(); }); grid.addEventListener('click', e=>{ const cell=e.target.closest('[role=gridcell]'); if(!cell) return; const sel=cell.getAttribute('aria-selected')==='true'; cell.setAttribute('aria-selected', String(!sel)); }); } break; }
    case 'toolbar': { const tb=root; if(tb){ tb.addEventListener('click', e=>{ const btn=e.target.closest('button'); if(btn){ const pressed=btn.getAttribute('aria-pressed')==='true'; btn.setAttribute('aria-pressed', String(!pressed)); } }); tb.addEventListener('keydown', e=>{ const items=[...tb.querySelectorAll('button')]; const current=document.activeElement; let idx=items.indexOf(current); if(e.key==='ArrowRight'){ e.preventDefault(); idx=(idx+1)%items.length; items[idx].focus(); } else if(e.key==='ArrowLeft'){ e.preventDefault(); idx=(idx-1+items.length)%items.length; items[idx].focus(); } }); } break; }
    case 'dialog':
    case 'alertdialog': { const openBtn=document.getElementById('open-dialog'); const dlg=root; const closeBtn=document.getElementById('close-dialog'); function open(){ dlg.hidden=false; dlg.querySelector('h3').focus(); } function close(){ dlg.hidden=true; openBtn.focus(); } if(openBtn && dlg){ openBtn.addEventListener('click', open); closeBtn && closeBtn.addEventListener('click', close); document.addEventListener('keydown', e=>{ if(e.key==='Escape' && !dlg.hidden) close(); }); } break; }
  }

  // Shadow DOM toggle - duplicates widget-root (light) into shadow root
  if(shadowToggle){ shadowToggle.addEventListener('click', ()=>{ shadowEnabled=!shadowEnabled; if(shadowEnabled){ shadowToggle.textContent='Disable Shadow DOM Variant'; const host=document.createElement('div'); host.className='shadow-wrapper'; shadowHostContainer.innerHTML=''; shadowHostContainer.appendChild(host); const sr=host.attachShadow({mode:'open'}); const clone=root.cloneNode(true); clone.id='shadow-clone'; sr.innerHTML='<style>'+document.getElementById('inline-style').textContent+'</style>'; sr.appendChild(clone); } else { shadowToggle.textContent='Enable Shadow DOM Variant'; shadowHostContainer.innerHTML=''; } }); }

})();